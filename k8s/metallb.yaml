# =======================================================
# ‚öôÔ∏è METALLB KONFIGURATION F√úR HETZNER-K3s
# =======================================================
# MetalLB ist ein LoadBalancer-Controller f√ºr "bare metal"-Kubernetes-Cluster.
# Er sorgt daf√ºr, dass Services vom Typ LoadBalancer eine externe IP bekommen,
# auch wenn du NICHT in AWS/GCP bist (z. B. Hetzner, dedizierter Server, o.√§.)
#
# üëâ Voraussetzungen:
# - Du hast deine Hetzner-IP (z. B. 91.98.120.205)
# - K3s l√§uft und kubectl funktioniert
# =======================================================

# 1Ô∏è‚É£ MetalLB selbst installieren (Namespace, Controller, Speaker)
#    Diese Manifest-Datei legt die Basis-Deployments an
#    und sorgt daf√ºr, dass MetalLB im Namespace "metallb-system" l√§uft.
#    Du kannst diesen Schritt auch manuell mit `kubectl apply -f` machen,
#    falls du ihn noch nicht ausgef√ºhrt hast.
---
apiVersion: v1
kind: Namespace
metadata:
  name: metallb-system

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: metallb-controller
  namespace: metallb-system
spec:
  replicas: 1
  selector:
    matchLabels:
      component: controller
  template:
    metadata:
      labels:
        component: controller
    spec:
      containers:
        - name: controller
          image: quay.io/metallb/controller:v0.13.10
          args:
            - --port=7472
            - --metrics-port=7473

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: metallb-speaker
  namespace: metallb-system
spec:
  selector:
    matchLabels:
      component: speaker
  template:
    metadata:
      labels:
        component: speaker
    spec:
      containers:
        - name: speaker
          image: quay.io/metallb/speaker:v0.13.10
          args:
            - --port=7472
            - --metrics-port=7473
          securityContext:
            privileged: true
      hostNetwork: true
      serviceAccountName: metallb-speaker

# =======================================================
# 2Ô∏è‚É£ IPAddressPool:
#    Definiert, welche IP-Adressen MetalLB verwenden darf.
#    In diesem Fall verwenden wir nur DEINE Hetzner-IP.
# =======================================================
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: my-ip-pool
  namespace: metallb-system
spec:
  addresses:
    - 91.98.120.205-91.98.120.205   # <-- Deine Hetzner-Server-IP

# =======================================================
# 3Ô∏è‚É£ L2Advertisement:
#    Gibt an, wie MetalLB IP-Adressen im lokalen Netzwerk verteilt.
#    "Layer2" bedeutet, dass MetalLB IPs direkt √ºber das Hostnetzwerk ank√ºndigt.
# =======================================================
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2adv
  namespace: metallb-system
